<!doctype html><html lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.82.0"><title>Race conditions in web applications â€¢ ðŸ‘€</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Race conditions in web applications"><meta name=twitter:description content="Race conditions are a common issue in web applications. This post presents the most effective techniques to prevent them."><meta property="og:title" content="Race conditions in web applications"><meta property="og:description" content="Race conditions are a common issue in web applications. This post presents the most effective techniques to prevent them."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kbck.pl/posts/2017-03-13-race-conditions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-13T15:02:12+02:00"><meta property="article:modified_time" content="2017-03-13T15:02:12+02:00"><link rel=stylesheet href=/scss/hyde-hyde.9181f25ed2263aeb878ec6f8a84f10c4ebb16150000fca8767308880bdde5ca0.css integrity="sha256-kYHyXtImOuuHjsb4qE8QxOuxYVAAD8qHZzCIgL3eXKA="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://blog.kbck.pl/>ðŸ‘€</a></span><p class=site__description>Jakub Kisielewski's Software Blog</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>ðŸ‘€</label><div class=menu-content><div><ul class=sidebar-nav></ul></div><section class=social><a href=https://twitter.com/kbkk_pl rel=me><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
<a href=https://github.com/kbkk rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a></section></div></div></div></div><div class="content container"><article><header><h1>Race conditions in web applications</h1><div class=post__meta><i class="fas fa-calendar-alt"></i> Mar 13, 2017<br><i class="fas fa-clock"></i> 3 min read</div></header><div class=post><h2 id=what-is-a-race-condition>What is a race condition?</h2><p>A race condition can happen when two or more threads try to work on the same data simultaneously. As a result the data might lose integrity.</p><h3 id=an-example>An example</h3><p>Imagine that you want to ensure every user of your web application has a unique email. So, when the users register you issue a SELECT with the provided email to a database, and if it doesn&rsquo;t return any results you INSERT the user. What can go wrong? Well, a race condition can. Here&rsquo;s the code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;SELECT * FROM users WHERE email = ?&#39;</span>, <span style=color:#a6e22e>email</span>)
    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>result</span> =&gt; {
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span>)
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;User with this email already exists!&#39;</span>);
        <span style=color:#66d9ef>else</span>
            <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`INSERT INTO users VALUES(?, ?)`</span>, <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>email</span>)
                .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`You&#39;ve registered successfully!`</span>));
    });
</code></pre></div><p>Now, if you register an account with the <code>mail@example.com</code> email you will see: <code>You've registered successfully!</code>.
If you do it again you should see: <code>User with this email already exists!</code>.
However! if you fire the register requests fast enough you will actually see:</p><pre><code>You've registered successfully!
You've registered successfully!
</code></pre><p>What just happened is a race condition.
Before the user is inserted in the first request, the second request has already done the SELECT query, and then they will both insert a record into the database.</p><p>Code for this scenario is available on my <a href=https://github.com/kbkk/race-condition-example/blob/8048800b961c24de488d5c5e623e9eb701ab4e6c/server.js>Github</a>.</p><h2 id=preventing-race-conditions>Preventing race conditions</h2><h3 id=unique-index>Unique index</h3><p>The way to fix the example would be adding a unique index on the email field:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> EmailUniqueIndex <span style=color:#66d9ef>ON</span> users(email)
</code></pre></div><p>Now if a race condition happens the following error will be thrown and the record won&rsquo;t be inserted:</p><pre><code>Error: SQLITE_CONSTRAINT: UNIQUE constraint failed: users_unique.email
at Error (native) errno: 19, code: 'SQLITE_CONSTRAINT'
</code></pre><p>With the unique index it would also be possible to completely drop the SELECT query:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>db</span>
    .<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`INSERT INTO users_unique VALUES(?, ?)`</span>, <span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>email</span>)
    .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`You&#39;ve registered successfully!`</span>))
    .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>errno</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>19</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>code</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;SQLITE_CONSTRAINT&#39;</span>)
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;User with this email already exists!&#39;</span>);
        <span style=color:#66d9ef>else</span>
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Something went wrong&#39;</span>);
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
    });
</code></pre></div><p>However, this solution has two cons:</p><ul><li>every database engine returns different error codes for the unique constraint violation</li><li>not all ORMs support this approach (as in, there may be no meaningful way to recognize the error code)</li></ul><h3 id=transactions>Transactions</h3><p>Transaction themselves don&rsquo;t prevent race conditions, and they cannot fix the example provided below.
Let&rsquo;s say you want to update a user&rsquo;s account balance and you run the following pseudocode mixed with SQL:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> balance <span style=color:#66d9ef>FROM</span> accounts <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>

<span style=color:#75715e>-- somewhere in app code:
</span><span style=color:#75715e></span>updatedBalance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>

<span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> updatedBalance <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>
</code></pre></div><p>This is how it could be fixed with a transaction:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>START</span> <span style=color:#66d9ef>TRANSACTION</span>
<span style=color:#66d9ef>SELECT</span> balance <span style=color:#66d9ef>FROM</span> accounts <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span> <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>UPDATE</span>

<span style=color:#75715e>-- somewhere in app code:
</span><span style=color:#75715e></span>updatedBalance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>

<span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> updatedBalance <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>
<span style=color:#66d9ef>COMMIT</span>
</code></pre></div><p>Using a transaction allows us to use the <code>FOR UPDATE</code> clause (syntax might be different among databases).
If a row is selected with <code>FOR UPDATE</code> it will be locked for other queries issued with <code>FOR UPDATE</code> unless a <code>COMMIT</code> is sent.
This is useful if the logic behind calculating the updated values is complicated and cannot be done with SQL.</p><h3 id=atomic-increment-or-decrement-update>Atomic increment or decrement update</h3><p>If you just need to increment or decrement a value in the database you can issue the following SQL:</p><pre><code>UPDATE accounts SET balance = balance + 100 WHERE id = 123
</code></pre><p>This will increment the balance by 100 and is race condition safe.</p><h2 id=more>More</h2><p>There are more places where race conditions can occur and more ways of fighting them.
If you want to get more knowledge in this area you should read about isolation levels, pessimistic locking and optimistic locking.</p><h3 id=bonus-content-real-world-scenarios>Bonus content (real world scenarios)</h3><ul><li><a href=https://josipfranjkovic.blogspot.com/2015/04/race-conditions-on-facebook.html>Printing money (DigitalOcean)</a></li><li><a href=https://github.com/digitalocean/hacktoberfest/issues/415>Free T-shirts (DigitalOcean again)</a></li><li><a href=https://www.bugsnag.com/blog/bug-day-race-condition-therac-25>Killing people (Therac-25 radiation therapy machine)</a></li></ul></div><div class="navigation navigation-single"></div></article></div><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script></body></html>